---
// Importar el JSON por defecto
import defaultMallaData from '../data/INF.json';
---

<!-- Botón para cargar archivo JSON -->
<div class="mb-6 text-center">
  <input type="file" id="jsonFileInput" accept=".json" class="hidden" />
  <button 
    id="loadJsonBtn" 
    class="bg-blue-600 text-white px-6 mt-10 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium"
  >
    Cargar  Malla 
  </button>
</div>

<div id="mallaContainer" class="overflow-x-auto py-2">
  <!-- El contenido de la malla se cargará aquí dinámicamente -->
</div>

<script>
  // Datos por defecto
  const defaultMallaData =
    {
  "name": "INF",
  "malla": {
    "s1": [
      ["Álgebra I","INF-111",5,8,"FI",[],"A"],
      ["Cálculo I","INF-112",5,8,"FI",[],"A"],
      ["Introducción a la Computación","INF-113",3,6,"CC",[],"I"],
      ["Introducción a la Ingeniería","INF-114",3,6,"FI",[],"A"],
      ["Inglés I","IFG-100",2,3,"HUM",[],"A"]
    ],
    "s2": [
      ["Álgebra II","INF-121",5,8,"FI",["INF-111"],"A"],
      ["Cálculo II","INF-122",5,8,"FI",["INF-112"],"A"],
      ["Programación","INF-123",5,8,"CC",["INF-113"],"P"],
      ["Comprensión Lectora y Prod. de Textos","INF-124",3,5,"FI",[],"A"],
      ["Inglés II","IFG-200",2,3,"HUM",["IFG-100"],"A"]
    ],
    "s3": [
      ["Física I","INF-211",4,6,"FI",[],"A"],
      ["Cálculo III","INF-212",4,6,"FI",["INF-122","INF-121"],"A"],
      ["Estructura de Datos","INF-213",4,6,"CC",["INF-123"],"I"],
      ["Expresión Oral en Ingeniería","INF-214",2,3,"FI",["INF-124"],"A"],
      ["Circuitos Digitales","INF-215",4,6,"AC",["INF-111"],"I"],
      ["Inglés III","IFG-300",2,3,"HUM",["IFG-200"],"A"]
    ],
    "s4": [
      ["Física II","INF-221",4,6,"FI",["INF-211"],"A"],
      ["Ecuaciones Diferenciales","INF-222",4,6,"FI",["INF-212"],"A"],
      ["Programación Avanzada","INF-223",3,5,"CC",["INF-213"],"P"],
      ["Lógica para Ciencia de la Computación","INF-224",3,5,"CC",["INF-111"],"P"],
      ["Arquitectura de Computadores","INF-225",4,6,"AC",["INF-215"],"P"],
      ["Módulo Integrador Ciencias Básicas","INF-226",2,3,"FI",["INF-211","INF-212","INF-213","INF-214","INF-215","IFG-300"],"A"]
    ],
    "s5": [
      ["Física III","INF-311",3,5,"FI",["INF-221"],"A"],
      ["Inferencia Estadística","INF-312",3,5,"FI",["INF-222"],"A"],
      ["Estructuras Discretas","INF-313",3,5,"CC",["INF-223"],"I"],
      ["Modelamiento de Datos","INF-314",3,5,"IS",["INF-223"],"I"],
      ["Taller de Circuitos Digitales","INF-315",2,4,"AC",["INF-225"],"I"],
      ["Introducción a la Fe","MFG-114",2,3,"HUM",[],"A"]
    ],
    "s6": [
      ["Computación Numérica","INF-321",4,6,"CC",["INF-222"],"P"],
      ["Investigación de Operaciones","INF-322",4,6,"CC",["INF-312"],"P"],
      ["Teoría de la Computación","INF-323",4,6,"CC",["INF-224"],"P"],
      ["Base de Datos","INF-324",4,6,"IS",["INF-314"],"P"],
      ["Sistemas Operativos","INF-325",4,6,"AC",["INF-225"],"P"],
      ["Ética Cristiana","MFG-216",2,3,"HUM",["MFG-114"],"A"]
    ],
    "s7": [
      ["Metodología de la Investigación","INF-411",3,5,"FI",["INF-226","INF-312"],"A"],
      ["Economía","INF-412",3,5,"GI",["INF-221","INF-222","INF-223","INF-224","INF-225","INF-226"],"I"],
      ["Diseño y Análisis de Algoritmos","INF-413",4,6,"CC",["INF-313"],"I"],
      ["Sistemas de Información","INF-414",4,6,"IS",["INF-324"],"I"],
      ["Comunicación de Datos y Redes","INF-415",4,6,"AC",["INF-325"],"I"]
    ],
    "s8": [
      ["Módulo Integrador de Licenciatura","INF-421",3,5,"FI",["INF-411","INF-412","INF-413","INF-414","INF-415"],"A"],
      ["Contabilidad y Finanzas","INF-422",3,5,"GI",["INF-412"],"P"],
      ["Inteligencia Artificial","INF-423",2,4,"CC",["INF-413"],"P"],
      ["Ingeniería de Software I","INF-424",3,5,"IS",["INF-414"],"P"],
      ["Redes Avanzadas","INF-425",2,4,"AC",["INF-415"],"P"],
      ["Certificación I","CERT-1",0,0,"CERT",[],"A"]
    ],
    "s9": [
      ["Formulación y Evaluación de Proyectos Informáticos","INF-511",3,5,"GI",["INF-422"],"I"],
      ["Gestión Informática I","INF-512",3,5,"GI",["INF-422"],"I"],
      ["Calidad y Productividad de Software","INF-513",3,5,"IS",["INF-424"],"I"],
      ["Ingeniería de Software II","INF-514",3,5,"IS",["INF-424"],"I"],
      ["Sistemas Distribuidos","INF-515",3,5,"AC",["INF-415"],"I"],
      ["Certificación II","CERT-2",0,0,"CERT",["CERT-1"],"A"]
    ],
    "s10": [
      ["Electivo I","INF-523",3,5,"EL",[],"P"],
      ["Recursos Humanos y Legislación","INF-521",3,5,"GI",[],"P"],
      ["Taller de Desarrollo de Software","INF-524",3,5,"IS",["INF-514"],"P"],
      ["Gestión Informática II","INF-522",3,5,"GI",["INF-512"],"P"],
      ["Seguridad de la Información","INF-525",3,5,"AC",["INF-425"],"P"],
      ["Certificación III","CERT-3",0,0,"CERT",["CERT-2"],"A"]
    ],
    "s11": [
      ["Electivo II","INF-611",3,5,"EL",[],"I"],
      ["Electivo III","INF-612",3,5,"EL",[],"I"],
      ["Módulo Integrador de Formación Profesional","INF-613",12,20,"FI",["INF-523","INF-521","INF-524","INF-522","INF-525","CERT-3"],"A"]
    ]
  },
  "categories": {
    "CC": ["#2E58A7", "Ciencias de la Computación"],
    "IS": ["#4CAF50", "Ingeniería de Software"],
    "AC": ["#FF6B35", "Arquitectura de Computadores"],
    "GI": ["#8E24AA", "Gestión Informática"],
    "FI": ["#00838F", "Fundamentos de la Ingeniería"],
    "HUM": ["#FF9800", "Humanístico"],
    "EL": ["#9C27B0", "Electivo"],
    "CERT": ["#F44336", "Certificación"]
  }
};

  // Función para obtener color por categoría
  function getColorPorCategoria(categoria: string, categories: Record<string, [string, string]>) {
    return categories[categoria] ? categories[categoria][0] : '#6B7280';
  }

  // Definición de tipos
  interface MallaRamo {
    [key: string]: [string, string, number, number, string, string[], string][];
  }

  interface MallaData {
    name: string;
    malla: MallaRamo;
    categories: Record<string, [string, string]>;
  }

  // Función para procesar datos de la malla
  function procesarMallaData(mallaData: MallaData) {
    return Object.keys(mallaData.malla).map(semestre => {
      const numeroSemestre = semestre.replace('s', '');
      return {
        nombre: `SEMESTRE ${numeroSemestre}`,
        ramos: mallaData.malla[semestre].map(ramo => ({
          nombre: ramo[0],
          sigla: ramo[1],
          creditosUSM: ramo[2],
          creditosSCT: ramo[3],
          categoria: ramo[4],
          prerrequisitos: ramo[5],
          indicador: ramo[6],
          color: getColorPorCategoria(ramo[4], mallaData.categories)
        }))
      };
    });
  }

  // Función para renderizar la malla
  function renderizarMalla(semestres, categories) {
    const container = document.getElementById('mallaContainer');
    
    const mallaHTML = `
      <div class="grid grid-cols-11 gap-px w-full">
        ${semestres.map(semestre => `
          <div class="bg-white rounded-lg p-0.5  2xl:w-[165px]">
            <h3 class="text-center font-bold text-white text-sm mb-3 bg-gray-700 py-3 rounded h-10 2xl:h16 flex items-center justify-center">
              ${semestre.nombre}
            </h3>
            <div class="flex flex-col gap-1.5">
              ${semestre.ramos.map(ramo => `
                <div class="text-xs 2xl:text-sm text-white px-2 py-2 rounded font-medium text-center cursor-pointer hover:opacity-80 transition-opacity h-16 2xl:h-22 flex items-center justify-center"
                     style="background-color: ${ramo.color}">   
                  ${ramo.nombre}
                </div>
              `).join('')}
            </div>
          </div>
        `).join('')}
      </div>
      
      <!-- Leyenda de categorías -->
      <div class="mt-8 px-8 py-6 bg-gray-50">
        <h4 class="text-lg font-bold mb-4 text-center">Leyenda de Categorías</h4>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
          ${Object.entries(categories).map(([categoria, [color, nombre]]) => `
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 rounded" style="background-color: ${color}"></div>
              <span class="text-sm font-medium">${categoria}: ${nombre}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    
    container.innerHTML = mallaHTML;
  }

  // Cargar malla por defecto al inicio
  document.addEventListener('DOMContentLoaded', () => {
    const semestres = procesarMallaData(defaultMallaData);
    renderizarMalla(semestres, defaultMallaData.categories);
  });

  // Manejar carga de archivo
  document.getElementById('loadJsonBtn').addEventListener('click', () => {
    document.getElementById('jsonFileInput').click();
  });

  document.getElementById('jsonFileInput').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file && file.type === 'application/json') {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const newMallaData = JSON.parse(e.target.result);
          const semestres = procesarMallaData(newMallaData);
          renderizarMalla(semestres, newMallaData.categories);
          alert('Malla cargada exitosamente!');
        } catch (error) {
          alert('Error al cargar el archivo JSON: ' + error.message);
        }
      };
      reader.readAsText(file);
    } else {
      alert('Por favor selecciona un archivo JSON válido.');
    }
  });
</script>